= rund
:project-handle: rund
:uri-project: https://github.com/slonopotamus/{project-handle}
:uri-ci: {uri-project}/actions?query=branch%3Amain
:source-highlighter: rouge

image:{uri-project}/workflows/CI/badge.svg?branch=main[GitHub Actions,link={uri-ci}]

rund is an experimental https://containerd.io[containerd] shim for macOS.

WARNING: This project is far from complete and is missing CRITICAL parts, like cleanup of multiple container processes. Do not use in production.

rund doesn't offer the usual level of container isolation that is achievable on other OSes due to limited macOS kernel API.

What rund provides is:

* Filesystem isolation via https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/chroot.2.html[`chroot(2)`]
* TODO: Cleanup of orphan processes via https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/killpg.2.html[`killpg(2)`]
* TODO: OCI Runtime Specification compatibility (to the extent it is possible on macOS)

== Prerequisites

* MacOS Catalina or newer
* Disable https://developer.apple.com/documentation/security/disabling_and_enabling_system_integrity_protection[System Identity Protection].
SIP https://github.com/containerd/containerd/discussions/5525#discussioncomment-2685649[doesn't allow] to `chroot`.

== Usage

[source,shell]
----
# Install macos-jail project that will create macOS chroot rootfs
git clone https://github.com/slonopotamus/macos-jail
cd macos-jail
pip3 install -e . --user
cd ..
# Build macOS rootfs in jail_dir
sudo python3 -m macosjail jail_dir

# Download go-porter
git clone https://github.com/bozaro/go-porter
cd go-porter
# Build macOS docker image
sudo go run cli/porter/main.go build ../jail_dir -f ../macos-jail/Dockerfile -t macos
sudo go run cli/porter/main.go save macos > ../macos.tgz

# Download containerd
git clone https://github.com/containerd/containerd
cd containerd
# Run containerd
sudo go run cmd/containerd/main.go

# Continue from a SEPARATE terminal, without stopping containerd

# Import macOS docker image into containerd
cd containerd
sudo go run cmd/ctr/main.go image import --all-platforms ../macos.tgz
cd ..

# Build rund
git clone https://github.com/slonopotamus/rund
cd rund
go build cmd/*.go
cd ..

# Aaaand... Run your first macOS container!
cd containerd
sudo go run cmd/ctr/main.go run --rm --runtime "$(pwd)/../rund/containerd-shim-rund-v1" docker.io/library/macos:latest my_container echo "Hello from macOS container ^_^"
----
